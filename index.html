<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Drone Sightings — Europe (Air, Sea & Infrastructure)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" crossorigin="anonymous" />
  <style>
    :root {
      --bg: #0f1115;
      --panel: #151823;
      --surface: #0f1322;
      --muted: #8a90a2;
      --text: #eef2ff;
      --border: #2a2f45;
      --chip: #21263a;
      --chip-active: #2b3250;
      --focus: #9db8ff;
      --severity-1: #9ca3af;
      --severity-2: #60a5fa;
      --severity-3: #f59e0b;
      --severity-4: #ef4444;
      --severity-5: #7e22ce;
      --air: #ef4444;
      --harbour: #3b82f6;
      --energy: #f97316;
      --rail: #22c55e;
      --border-crossing: #eab308;
      --military: #c084fc;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); font-family: "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial; }
    #app { display: grid; grid-template-columns: 320px 1fr 360px; grid-template-rows: 56px 1fr; height: 100%; }
    header { grid-column: 1 / 4; display: flex; align-items: center; gap: 12px; padding: 10px 16px; background: #0c0f17; border-bottom: 1px solid var(--border); }
    header h1 { font-size: 16px; margin: 0; letter-spacing: .4px; }
    header .badge { padding: 4px 8px; background: var(--chip); border: 1px solid var(--border); border-radius: 999px; color: var(--muted); font-size: 12px; }
    #left, #right { background: var(--panel); padding: 12px; overflow: auto; }
    #left { border-right: 1px solid var(--border); }
    #right { border-left: 1px solid var(--border); }
    #map { width: 100%; height: 100%; }
    h2 { font-size: 13px; font-weight: 700; text-transform: uppercase; color: var(--muted); letter-spacing: .08em; margin: 8px 0 6px; }
    .section { margin-bottom: 16px; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { padding: 6px 10px; border: 1px solid var(--border); border-radius: 999px; background: var(--chip); color: var(--text); cursor: pointer; font-size: 12px; transition: background .2s ease; }
    .chip.active { background: var(--chip-active); border-color: #3a4162; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input[type="range"] { width: 100%; }
    select, input[type="text"] { width: 100%; padding: 8px 10px; background: var(--surface); color: var(--text); border: 1px solid var(--border); border-radius: 8px; outline: none; }
    select:focus, input[type="text"]:focus { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(157,184,255,.15); }
    .legend { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; font-size: 12px; }
    .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; border: 1px solid rgba(0,0,0,.4); }
    .sev { display: inline-block; width: 10px; height: 10px; border-radius: 2px; margin-right: 4px; }
    .sev.s1 { background: var(--severity-1); }
    .sev.s2 { background: var(--severity-2); }
    .sev.s3 { background: var(--severity-3); }
    .sev.s4 { background: var(--severity-4); }
    .sev.s5 { background: var(--severity-5); }
    .statbar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
    .stat { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 10px; text-align: center; }
    .stat .k { font-size: 18px; font-weight: 700; }
    .incident { border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-bottom: 10px; background: var(--surface); cursor: pointer; transition: border .2s ease; }
    .incident:hover { border-color: #3a4162; }
    .muted { color: var(--muted); font-size: 12px; }
    .leaflet-control-attribution { background: rgba(0,0,0,.45); color: #dfe4ff; border-radius: 8px; padding: 2px 6px; }
    .leaflet-popup-content-wrapper { background: var(--surface); color: var(--text); }
    .leaflet-popup-tip { background: var(--surface); }
    @media (max-width: 1120px) {
      #app { grid-template-columns: 1fr; grid-template-rows: 56px 260px 1fr 320px; }
      #left { grid-row: 2; }
      #map { grid-row: 3; }
      #right { grid-row: 4; }
      header { grid-column: 1; }
    }
  </style>
</head>
<body>
  <div id="app" role="application" aria-label="Drone Sightings interactive map">
    <header>
      <h1>Drone Sightings — Europe (Air, Sea & Critical Nodes)</h1>
      <span class="badge">Satellite</span>
      <span class="badge" id="badge-refresh">Auto refresh</span>
      <span class="badge" id="badge-generated">Generated: —</span>
    </header>

    <aside id="left" aria-label="Filters">
      <div class="section">
        <h2>Time Window</h2>
        <div class="chips" role="group" aria-label="Quick time windows">
          <button class="chip" data-window="7">7d</button>
          <button class="chip" data-window="30">30d</button>
          <button class="chip" data-window="90">90d</button>
          <button class="chip active" data-window="365">365d</button>
        </div>
        <label for="dateRange">Filter by days</label>
        <input id="dateRange" type="range" min="1" max="365" value="365" step="1" aria-valuemin="1" aria-valuemax="365" aria-valuenow="365" />
        <div class="muted" id="dateRangeLabel">Showing last 365 days</div>
      </div>

      <div class="section">
        <h2>Asset Layers</h2>
        <div class="legend" role="group" aria-label="Asset toggles">
          <label><input type="checkbox" id="layer-airport" checked /> <span class="dot" style="background:var(--air);"></span> Airports</label>
          <label><input type="checkbox" id="layer-harbour" checked /> <span class="dot" style="background:var(--harbour);"></span> Harbours</label>
          <label><input type="checkbox" id="layer-energy" /> <span class="dot" style="background:var(--energy);"></span> Energy</label>
          <label><input type="checkbox" id="layer-rail" /> <span class="dot" style="background:var(--rail);"></span> Rail hubs</label>
          <label><input type="checkbox" id="layer-border" /> <span class="dot" style="background:var(--border-crossing);"></span> Border crossings</label>
          <label><input type="checkbox" id="layer-military" /> <span class="dot" style="background:var(--military);"></span> Military</label>
        </div>
      </div>

      <div class="section">
        <h2>Status & Evidence</h2>
        <label for="statusSelect">Status</label>
        <select id="statusSelect" multiple size="3">
          <option value="active" selected>Active</option>
          <option value="resolved" selected>Resolved</option>
          <option value="unconfirmed">Unconfirmed</option>
        </select>

        <label style="margin-top:8px;" for="evidenceSelect">Evidence strength</label>
        <select id="evidenceSelect" multiple size="4">
          <option value="3" selected>3 — Official/NOTAM/NAVTEX</option>
          <option value="2" selected>2 — Multi tier-1 reports</option>
          <option value="1" selected>1 — Single credible</option>
          <option value="0">0 — Unconfirmed</option>
        </select>
      </div>

      <div class="section">
        <h2>Find</h2>
        <label for="searchBox">Search assets, sources, narratives</label>
        <input id="searchBox" type="text" placeholder="e.g., CPH, Nordhavn, Reuters" />
      </div>

      <div class="section">
        <h2>Severity legend</h2>
        <div class="legend">
          <span><span class="sev s1"></span>1</span>
          <span><span class="sev s2"></span>2</span>
          <span><span class="sev s3"></span>3</span>
          <span><span class="sev s4"></span>4</span>
          <span><span class="sev s5"></span>5</span>
        </div>
      </div>

      <div class="section">
        <h2>Summary</h2>
        <div class="statbar">
          <div class="stat"><div class="k" id="stat-total">0</div><div class="muted">Incidents</div></div>
          <div class="stat"><div class="k" id="stat-air">0</div><div class="muted">Airports</div></div>
          <div class="stat"><div class="k" id="stat-har">0</div><div class="muted">Harbours</div></div>
        </div>
      </div>

      <div class="section muted" style="font-size:11px;">
        Basemap © Esri; OSM contributors. Data refreshes hourly; UI reloads automatically every 5 minutes.
      </div>
    </aside>

    <main id="map" role="region" aria-label="Incident map"></main>

    <aside id="right" aria-label="Incident details">
      <div id="details">
        <h2>Incident feed</h2>
        <p class="muted" id="detailsIntro">Pins refresh every few minutes. Click a marker or list item for full provenance.</p>
        <div id="incidentList"></div>
      </div>
    </aside>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" crossorigin="anonymous"></script>
  <script>
    const INCIDENTS_PATHS = [
      'incidents.json',
      'public/incidents.json'
    ];
    const REFRESH_MS = 5 * 60 * 1000;

    const assetColors = {
      airport: getComputedStyle(document.documentElement).getPropertyValue('--air') || '#ef4444',
      harbour: getComputedStyle(document.documentElement).getPropertyValue('--harbour') || '#3b82f6',
      energy: getComputedStyle(document.documentElement).getPropertyValue('--energy') || '#f97316',
      rail: getComputedStyle(document.documentElement).getPropertyValue('--rail') || '#22c55e',
      border: getComputedStyle(document.documentElement).getPropertyValue('--border-crossing') || '#eab308',
      military: getComputedStyle(document.documentElement).getPropertyValue('--military') || '#c084fc'
    };

    const map = L.map('map', {
      center: [56, 12],
      zoom: 4,
      minZoom: 3,
      worldCopyJump: true
    });

    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Basemap © Esri — Sources: Esri, i-cubed, USDA, USGS, AeroGRID, IGN, IGP'
    }).addTo(map);
    const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    });
    L.control.layers({ 'Satellite': satellite, 'Streets': streets }, null, { collapsed: true }).addTo(map);

    const clusterGroups = {
      airport: L.markerClusterGroup({ disableClusteringAtZoom: 10 }),
      harbour: L.markerClusterGroup({ disableClusteringAtZoom: 10 }),
      energy: L.markerClusterGroup({ disableClusteringAtZoom: 8 }),
      rail: L.markerClusterGroup({ disableClusteringAtZoom: 8 }),
      border: L.markerClusterGroup({ disableClusteringAtZoom: 8 }),
      military: L.markerClusterGroup({ disableClusteringAtZoom: 8 })
    };
    Object.values(clusterGroups).forEach(group => map.addLayer(group));

    const state = {
      data: { generated_utc: null, incidents: [] },
      markers: new Map()
    };

    function sevBox(score) {
      const level = Math.min(5, Math.max(1, Number(score) || 1));
      return `<span class="sev s${level}"></span>`;
    }

    function markerIcon(color, severity) {
      const size = 10 + (Number(severity) || 1) * 2;
      return L.divIcon({
        html: `<div style="width:${size}px;height:${size}px;border-radius:50%;background:${color.trim()};border:2px solid rgba(15,17,25,0.85);box-shadow:0 0 0 1px rgba(0,0,0,.35);"></div>`,
        className: '',
        iconSize: [size, size]
      });
    }

    function fmtDate(value) {
      if (!value) return '—';
      try {
        return new Date(value).toISOString().slice(0, 16).replace('T', ' ');
      } catch (err) {
        return value;
      }
    }

    function fmtDuration(minutes) {
      if (minutes == null) return '—';
      if (minutes < 60) return `${minutes} min`;
      return `${(minutes / 60).toFixed(1)} h`;
    }

    function activeDays() {
      return parseInt(document.getElementById('dateRange').value, 10) || 365;
    }

    function selectedValues(select) {
      const opts = Array.from(select.selectedOptions).map(opt => opt.value);
      return opts.length ? opts : Array.from(select.options).map(opt => opt.value);
    }

    function assetToggles() {
      return {
        airport: document.getElementById('layer-airport').checked,
        harbour: document.getElementById('layer-harbour').checked,
        energy: document.getElementById('layer-energy').checked,
        rail: document.getElementById('layer-rail').checked,
        border: document.getElementById('layer-border').checked,
        military: document.getElementById('layer-military').checked
      };
    }

    function searchTerm() {
      return document.getElementById('searchBox').value.trim().toLowerCase();
    }

    function filterIncidents() {
      const cutoff = Date.now() - activeDays() * 24 * 3600 * 1000;
      const statuses = new Set(selectedValues(document.getElementById('statusSelect')));
      const evidences = new Set(selectedValues(document.getElementById('evidenceSelect')));
      const query = searchTerm();

      return state.data.incidents.filter(item => {
        const seenTs = Date.parse(item.first_seen_utc || item.last_update_utc || state.data.generated_utc || Date.now());
        if (Number.isFinite(cutoff) && seenTs < cutoff) return false;
        if (!statuses.has(item.incident.status)) return false;
        if (!evidences.has(String(item.evidence.strength))) return false;
        if (query) {
          const haystack = [
            item.asset.name,
            item.asset.iata,
            item.asset.icao,
            item.incident.narrative,
            ...(item.evidence.sources || []).map(src => src.publisher)
          ].join(' ').toLowerCase();
          if (!haystack.includes(query)) return false;
        }
        return true;
      });
    }

    function popupHtml(incident) {
      const srcLinks = (incident.evidence.sources || []).slice(0, 2).map(src => {
        const label = src.publisher || 'source';
        return `<a href="${src.url}" target="_blank" rel="noopener">${label}</a>`;
      }).join(' · ');
      return `
        <strong>${incident.asset.name}${incident.asset.iata ? ` (${incident.asset.iata})` : ''}</strong><br />
        <b>Asset:</b> ${incident.asset.type} · ${sevBox(incident.scores.severity)} <b>Severity:</b> ${incident.scores.severity}<br />
        <b>Status:</b> ${incident.incident.status} · <b>Category:</b> ${incident.incident.category}<br />
        <b>Window:</b> ${fmtDate(incident.first_seen_utc)} → ${fmtDate(incident.last_update_utc)}<br />
        <b>Evidence:</b> ${incident.evidence.strength} · ${srcLinks || '<span class="muted">no link</span>'}
      `;
    }

    function renderDetails(incidents) {
      const list = document.getElementById('incidentList');
      const intro = document.getElementById('detailsIntro');
      list.innerHTML = '';
      if (!incidents.length) {
        intro.textContent = 'No incidents match the current filters. Expand the window or enable more statuses.';
        return;
      }
      intro.textContent = 'Most recent incidents. Click to focus on the map.';
      incidents.sort((a, b) => Date.parse(b.first_seen_utc) - Date.parse(a.first_seen_utc));
      incidents.slice(0, 12).forEach(incident => {
        const card = document.createElement('div');
        card.className = 'incident';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;gap:10px;align-items:center;">
            <strong>${incident.asset.name}</strong>
            <span class="muted">${incident.asset.type}</span>
          </div>
          <div class="muted" style="margin:6px 0">${fmtDate(incident.first_seen_utc)} → ${fmtDate(incident.last_update_utc)}</div>
          <div>Category: <b>${incident.incident.category}</b> • Status: <b>${incident.incident.status}</b> • Evidence: <b>${incident.evidence.strength}</b> • Severity: <b>${incident.scores.severity}</b></div>
          <div class="muted" style="margin:6px 0">${incident.incident.narrative || ''}</div>
          <div>Sources: ${(incident.evidence.sources || []).map(src => `<a href="${src.url}" target="_blank" rel="noopener">${src.publisher || 'source'}</a>`).join(' · ') || '<span class="muted">—</span>'}</div>
        `;
        card.addEventListener('click', () => focusIncident(incident));
        list.appendChild(card);
      });
    }

    function focusIncident(incident) {
      const marker = state.markers.get(incident.id);
      if (!marker) return;
      map.setView(marker.getLatLng(), Math.max(map.getZoom(), 7));
      marker.openPopup();
    }

    function render() {
      Object.values(clusterGroups).forEach(group => group.clearLayers());
      state.markers.clear();
      const filtered = filterIncidents();
      const toggles = assetToggles();
      const mapMarkers = [];
      let countAir = 0;
      let countHar = 0;

      filtered.forEach(incident => {
        const assetType = incident.asset.type;
        if (!toggles[assetType]) return;
        const color = assetColors[assetType] || '#6ea8fe';
        const marker = L.marker([incident.asset.lat, incident.asset.lon], {
          icon: markerIcon(color, incident.scores.severity)
        }).bindPopup(popupHtml(incident));
        marker.on('click', () => renderDetails([incident]));
        state.markers.set(incident.id, marker);
        if (clusterGroups[assetType]) {
          clusterGroups[assetType].addLayer(marker);
        }
        mapMarkers.push(marker);
        if (assetType === 'airport') countAir += 1;
        if (assetType === 'harbour') countHar += 1;
      });

      document.getElementById('stat-total').textContent = filtered.length;
      document.getElementById('stat-air').textContent = countAir;
      document.getElementById('stat-har').textContent = countHar;

      if (mapMarkers.length) {
        const group = L.featureGroup(mapMarkers);
        map.fitBounds(group.getBounds().pad(0.2));
      }

      renderDetails(filtered);
    }

    async function fetchIncidents() {
      const cacheBust = Date.now();
      let lastError = null;

      for (const path of INCIDENTS_PATHS) {
        try {
          const res = await fetch(`${path}?_=${cacheBust}`, { cache: 'no-store' });
          if (!res.ok) {
            lastError = new Error(`HTTP ${res.status} for ${path}`);
            continue;
          }
          const data = await res.json();
          state.data = data;
          document.getElementById('badge-generated').textContent = `Generated: ${data.generated_utc || '—'}`;
          return;
        } catch (err) {
          lastError = err;
        }
      }

      console.error('Failed to fetch incidents dataset', lastError);
    }

    async function refreshAll() {
      await fetchIncidents();
      render();
    }

    function setupUI() {
      const dateRange = document.getElementById('dateRange');
      const dateLabel = document.getElementById('dateRangeLabel');
      document.querySelectorAll('.chip[data-window]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.chip[data-window]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          dateRange.value = btn.dataset.window;
          dateLabel.textContent = `Showing last ${dateRange.value} days`;
          render();
        });
      });
      [
        dateRange,
        document.getElementById('statusSelect'),
        document.getElementById('evidenceSelect'),
        document.getElementById('layer-airport'),
        document.getElementById('layer-harbour'),
        document.getElementById('layer-energy'),
        document.getElementById('layer-rail'),
        document.getElementById('layer-border'),
        document.getElementById('layer-military')
      ].forEach(control => {
        control.addEventListener('input', render);
        control.addEventListener('change', render);
      });
      document.getElementById('searchBox').addEventListener('input', render);
      dateLabel.textContent = `Showing last ${dateRange.value} days`;
    }

    setupUI();
    refreshAll();
    setInterval(refreshAll, REFRESH_MS);
  </script>
</body>
</html>
